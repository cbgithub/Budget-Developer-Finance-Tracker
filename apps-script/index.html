<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Budget Tracker</title>

  <!-- Include Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Include Chart.js for Pie Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Custom Styles for Dark Theme and Color Scheme -->
  <style>
    body {
      background-color: #343a40;
      /* Dark Grey */
      color: #f8f9fa;
      /* Light text for contrast */
    }

    .navbar {
      background-color: #007bff;
      /* Blue */
    }

    .navbar-brand,
    .nav-link {
      color: #ffffff !important;
      /* White text in navbar */
      margin-left: 20px;
      /* Optional: Adjust space around the navbar */

    }

    .navbar-nav .nav-link:hover {
      background-color: #0056b3;
      /* Darker Blue on hover */
    }

    .card,
    .btn {
      background-color: #495057;
      /* Darker Grey for Cards/Buttons */
      border: none;
    }

    .card-title {
      color: #ffffff;
    }

    .card-body {
      color: #f8f9fa;
    }

    .btn-primary {
      background-color: #28a745;
      /* Green */
      border-color: #28a745;
    }

    .btn-danger {
      background-color: #dc3545;
      /* Red */
      border-color: #dc3545;
    }

    .btn-warning {
      background-color: #ffc107;
      /* Yellow */
      border-color: #ffc107;
    }

    .form-control {
      background-color: #495057;
      /* Dark Grey Form Inputs */
      color: #ffffff;
      /* Light text */
    }

    .modal-content {
      background-color: #343a40;
      /* Dark Grey Modal */
      color: #f8f9fa;
    }

    .modal-header,
    .modal-footer {
      border-bottom: none;
    }

    .modal-title {
      color: #007bff;
      /* Blue Modal Title */
    }

    .list-group-item {
      background-color: #495057;
      border: none;
    }

    .list-group-item:hover {
      background-color: #007bff;
      /* Blue on hover */
    }

    /* Card Spacing */
    .card {
      margin-bottom: 20px;
      /* Adds space between cards */
    }

    .chart-container {
      height: 300px;
    }

    /* Custom modal close button */
    .close-btn {
      color: white;
      /* Set text color to white */
      background: none;
      /* Remove background */
      border: none;
      /* Remove border */
      font-size: 20px;
      /* Adjust font size if needed */
      cursor: pointer;
      /* Ensure it's clickable */
    }

    .close-btn:hover {
      color: white;
      /* Keep it white on hover */
      opacity: 0.7;
      /* Optionally reduce opacity on hover */
    }

    /* General Button Container Styles */
    .button-container {
      display: flex;
      flex-wrap: wrap;
      /* Allow buttons to wrap on smaller screens */
      justify-content: center;
      /* Center the buttons */
      gap: 15px;
      /* Space between buttons */
      margin: 15px 0;
      /* Add margin for separation from other content */
      padding: 0;
    }

    .button-container .btn {
      width: auto;
      /* Prevent buttons from stretching on large screens */
      padding: 10px 20px;
      /* Adjust padding for better clickability */
      font-size: 1rem;
      /* Adjust font size */
    }

    .button-container .btn:last-child {
      margin-right: 0;
      /* Remove right margin from the last button */
    }

    .pagination-spacing {
      margin-bottom: 60px;
      /* Adjust value as needed */
    }


    /* For mobile responsiveness: stack buttons vertically */
    @media (max-width: 767px) {
      .filter-container {
        margin-bottom: 20px;
        /* Adds space between filters and buttons */
      }

      .button-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        /* Center buttons horizontally */
        gap: 0.01rem;
        /* Space between buttons */
        margin-top: 5px;
      }

      .button-container .btn {
        width: 100%;
        /* Allow buttons to be full width on small screens */
        padding: 12px 0;
        /* Make buttons easier to tap */
        margin-bottom: 10px;
        /* Space between stacked buttons */
      }

      .button-container .btn:last-child {
        margin-bottom: 0;
        /* Remove bottom margin from the last button */
      }
    }

    /* For larger screens: ensure buttons stay horizontally aligned */
    @media (min-width: 768px) {

      .filter-container,
      .button-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .button-container {
        justify-content: flex-end;
        /* Right-align buttons on larger screens */
      }

      .button-container .btn {
        width: auto;
        /* Keep button width to content size */
        padding: 10px 20px;
        /* Keep button padding */
      }

      /* Ensure the "remaining amount" alert fits on mobile */
      #remainingPlanItemAmountDisplay {
        font-size: 0.9rem;
        /* Slightly smaller text */
        padding: 10px;
        /* Add some padding */
      }

      /* Ensure the "remaining amount" alert fits on mobile */
      #remainingIncomeItemAmountDisplay {
        font-size: 0.9rem;
        /* Slightly smaller text */
        padding: 10px;
        /* Add some padding */
      }
    }

      /* Make earned badges glow */
    .badge-earned {
      box-shadow: 0 0 10px #28a745, 0 0 20px #28a745;
      transition: box-shadow 0.3s ease, transform 0.3s ease;
    }

    /* Subtle hover effect for all badge cards */
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 20px rgba(0, 123, 255, 0.3);
    }
  </style>

  <!-- Include jQuery and Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container mt-4">
      <a class="navbar-brand " href="#">  <!--<img src="https://drive.google.com/thumbnail?id=1h4IV6BIqnI7at2AoQuy_TxQYXlmVAGC8&sz=w1000" style="display: inline-block;" width="140px" height="50px">-->Budget Developer App</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
      <div class="collapse navbar-collapse" id="navbarNav">

        <ul class="navbar-nav">

          <li class="nav-item"><a class="nav-link" href="#" onclick="loadPage('summary')">Summary</a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="loadPage('categories')">Categories</a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="loadPage('income')">Income</a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="loadPage('plan')">Plan</a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="loadPage('badges')">Badges</a></li>

        </ul>
      </div>
    </div>
  </nav>



  <!-- Main Content -->
  <div id="main-content" class="container mt-4"></div>

  <div id="spinner-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999;">
    <div class="spinner-border text-primary" role="status" style="position: fixed; top: 50%; left: 50%;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  <!-- Add Category Modal -->
  <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addCategoryModalLabel">Add New Category</h5>
          <button type="button" class="close-btn" data-bs-dismiss="modal" aria-label="Close">X</button>
        </div>
        <div class="modal-body">
          <input type="text" id="categoryName" class="form-control" placeholder="Category Name">
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="addCategory()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Category Modal -->
  <div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editCategoryModalLabel">Edit Category</h5>
          <button type="button" class="close-btn" data-bs-dismiss="modal" aria-label="Close">X</button>
        </div>
        <div class="modal-body">
          <input type="text" id="editCategoryName" class="form-control" placeholder="Category Name">
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="updateCategory()">Save</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-labelledby="deleteCategoryModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteCategoryModalLabel">Confirm Deletion</h5>
          <button type="button" class="close-btn" data-bs-dismiss="modal" aria-label="Close">X</button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this category? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteCategoryBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Income Modal -->
  <div class="modal fade" id="addIncomeModal" tabindex="-1" aria-labelledby="addIncomeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addIncomeModalLabel">Add New Income</h5>
          <button type="button" class="close-btn" data-bs-dismiss="modal" aria-label="Close">X</button>
        </div>
        <div class="modal-body">
          <input type="text" id="incomeSource" class="form-control" placeholder="Income Source">
          <input type="number" id="incomeAmount" class="form-control mt-3" placeholder="Amount">
          <select id="incomeMonth" class="form-control mt-3">
            <option value="January">January</option>
            <option value="February">February</option>
            <option value="March">March</option>
            <option value="April">April</option>
            <option value="May">May</option>
            <option value="June">June</option>
            <option value="July">July</option>
            <option value="August">August</option>
            <option value="September">September</option>
            <option value="October">October</option>
            <option value="November">November</option>
            <option value="December">December</option>
          </select>
          <select id="incomeYear" class="form-control mt-3">
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
            <option value="2031">2031</option>
            <option value="2032">2032</option>
            <option value="2033">2033</option>
            <option value="2034">2034</option>
            <option value="2035">2035</option>
    
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="addIncome()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Income Modal -->
  <div class="modal fade" id="editIncomeModal" tabindex="-1" aria-labelledby="editIncomeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editIncomeModalLabel">Edit Income</h5>
          <button type="button" class="close-btn" data-bs-dismiss="modal" aria-label="Close">X</button>
        </div>
        <div class="modal-body">
          <input type="text" id="editIncomeSource" class="form-control" placeholder="Income Source">
          <input type="number" id="editIncomeAmount" class="form-control mt-3" placeholder="Amount">
          <select id="editIncomeMonth" class="form-control mt-3">
            <option value="January">January</option>
            <option value="February">February</option>
            <option value="March">March</option>
            <option value="April">April</option>
            <option value="May">May</option>
            <option value="June">June</option>
            <option value="July">July</option>
            <option value="August">August</option>
            <option value="September">September</option>
            <option value="October">October</option>
            <option value="November">November</option>
            <option value="December">December</option>
          </select>
          <select id="editIncomeYear" class="form-control mt-3">
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
            <option value="2031">2031</option>
            <option value="2032">2032</option>
            <option value="2033">2033</option>
            <option value="2034">2034</option>
            <option value="2035">2035</option>
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="updateIncome()">Save</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteIncomeModal" tabindex="-1" aria-labelledby="deleteIncomeModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteIncomeModalLabel">Confirm Deletion</h5>
          <button type="button" class="close-btn" data-bs-dismiss="modal" aria-label="Close">X</button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this income? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteIncomeBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Add Plan Modal -->
  <div class="modal fade" id="addPlanModal" tabindex="-1" aria-labelledby="addPlanModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addPlanModalLabel">Add New Plan</h5>
          <button type="button" class="close-btn" data-bs-dismiss="modal" aria-label="Close">X</button>
        </div>
        <div class="modal-body">

          <select id="planCategory" class="form-control mt-3">
          <!-- Categories will be dynamically populated -->
          </select>
          <select id="planSystemCategory" class="form-control mt-3">
          <!-- Categories will be dynamically populated -->
          </select>
          <input type="number" id="planAmount" class="form-control mt-3" placeholder="Amount">
          <select id="planMonth" class="form-control mt-3">
            <option value="January">January</option>
            <option value="February">February</option>
            <option value="March">March</option>
            <option value="April">April</option>
            <option value="May">May</option>
            <option value="June">June</option>
            <option value="July">July</option>
            <option value="August">August</option>
            <option value="September">September</option>
            <option value="October">October</option>
            <option value="November">November</option>
            <option value="December">December</option>
          </select>

          <select id="planYear" class="form-control mt-3">
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
            <option value="2031">2031</option>
            <option value="2032">2032</option>
            <option value="2033">2033</option>
            <option value="2034">2034</option>
            <option value="2035">2035</option>
          </select>
          <input type="text" id="planSource" class="form-control mt-3" placeholder="Plan Description">


        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="addPlan()">Save</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Edit Plan Modal -->
  <div class="modal fade" id="editPlanModal" tabindex="-1" aria-labelledby="editPlanModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editPlanModalLabel">Edit Plan</h5>
          <button type="button" class="close-btn" data-bs-dismiss="modal" aria-label="Close">X</button>
        </div>
        <div class="modal-body">

          <select id="editPlanCategory" class="form-control mt-3">
          <!-- Categories will be dynamically populated -->
          </select>
           <select id="editPlanSystemCategory" class="form-control mt-3">
          <!-- Categories will be dynamically populated -->
          </select>
          <input type="number" id="editPlanAmount" class="form-control mt-3" placeholder="Amount">
          <select id="editPlanMonth" class="form-control mt-3">
            <option value="January">January</option>
            <option value="February">February</option>
            <option value="March">March</option>
            <option value="April">April</option>
            <option value="May">May</option>
            <option value="June">June</option>
            <option value="July">July</option>
            <option value="August">August</option>
            <option value="September">September</option>
            <option value="October">October</option>
            <option value="November">November</option>
            <option value="December">December</option>
          </select>

          <select id="editPlanYear" class="form-control mt-3">
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
            <option value="2031">2031</option>
            <option value="2032">2032</option>
            <option value="2033">2033</option>
            <option value="2034">2034</option>
            <option value="2035">2035</option>
          </select>
          <input type="text" id="editPlanSource" class="form-control mt-3" placeholder="Plan Description">


        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="updatePlan()">Save</button>
        </div>
      </div>
    </div>
  </div>



  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deletePlanModal" tabindex="-1" aria-labelledby="deletePlanModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deletePlanModalLabel">Confirm Deletion</h5>
          <button type="button" class="close-btn" data-bs-dismiss="modal" aria-label="Close">X</button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this plan? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeletePlanBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Transaction Modal -->
  <div class="modal fade" id="addTransactionModal" tabindex="-1" aria-labelledby="addTransactionModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addTransactionModalLabel" data-bs-toggle="tooltip" data-bs-placement="top">Add New
            Transaction</h5>
          <button type="button" class="close-btn" data-bs-dismiss="modal" aria-label="Close">X</button>
        </div>
        <div class="modal-body">
          <input type="text" id="transactionDesc" class="form-control mt-3" placeholder="Transaction Description">
          <input type="number" id="transactionAmount" class="form-control mt-3" placeholder="Amount">
       

        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="addTransaction()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Transaction Modal -->
  <div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editTransactionModalLabel">Edit Transaction</h5>
          <button type="button" class="close-btn" data-bs-dismiss="modal" aria-label="Close">X</button>
        </div>
        <div class="modal-body">
          <input type="text" id="editTransactionDesc" class="form-control mt-3" placeholder="Transaction Description">
          <input type="number" id="editTransactionAmount" class="form-control mt-3" placeholder="Amount">
         

        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="updateTransaction()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteTransactionModal" tabindex="-1" aria-labelledby="deleteTransactionModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteTransactionModalLabel">Confirm Deletion</h5>
          <button type="button" class="close-btn" data-bs-dismiss="modal" aria-label="Close">X</button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this transaction? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteTransactionBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>










  <script>
    let categories = []; // Store categories in an array for CRUD operations
    let currentCategoryId = null;
    let currentIncomeId = null;
    let currentPlanId = null;
    let currentTransactionId = null;
    let incomes = []; // Store incomes in an array
    let categoryToDelete = null; // Store the index of the category to delete
    let incomeToDelete = null;
    let planToDelete = null;
    let plans = [];
    let transactions = [];
    let incomesCache = [];
    let plansCache = [];
    let categoriesCache = [];
    let transactionsCache = [];
  
    const cacheExpiry = 120000; 
    let summaryCache = {};
    // Global pagination state
    let currentPage = 1;
    let totalPages = 1;
    const itemsPerPage = 25; // Number of items per page

    // To get the month name:
    const monthNames = ["January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];
        
    function showSpinner() {
      document.getElementById('spinner-overlay').style.display = 'block';
    }

    function hideSpinner() {
      document.getElementById('spinner-overlay').style.display = 'none';
    }


    // Initial Load
    loadPage('summary');

    // Load page content dynamically
    function loadPage(page) {
      switch(page) {
        case 'summary':
        loadSummary();
          break;
        case 'categories':
          loadCategories();
          break;
        case 'income':
          loadIncome();
          break;
        case 'plan':
          loadPlans();
          //updateRemainingIncomeAmountDisplay();
          break;
        case 'badges':
          loadBadges();
          break;
      }
    }

    // Focus input on modal show
    $('#editCategoryModal').on('shown.bs.modal', function () {
    $('#editCategoryName').focus();
    });

    function updateModalTitle(modalId, baseTitle, contextName) {
    const modalLabel = $(`#${modalId}Label`);
    const truncatedName = contextName.length > 20 ? contextName.substring(0, 17) + "..." : contextName;

    // Destroy any existing tooltip
    modalLabel.tooltip('dispose');

    // Update title and add tooltip
    modalLabel
        .text(`${baseTitle}: ${truncatedName}`)
        .attr('title', contextName)
        .tooltip();
    }






    function isJson(data) {
      try {
        JSON.parse(data);
        return true;
      } catch (e) {
        return false;
      }
    }

    // Function to generate a distinct color for each category
    function generateColors(count) {
      const colors = [];
      for (let i = 0; i < count; i++) {
        // Generate random RGB values
        const r = Math.floor(Math.random() * 255);
        const g = Math.floor(Math.random() * 255);
        const b = Math.floor(Math.random() * 255);
        colors.push(`rgb(${r}, ${g}, ${b})`);
      }
      return colors;
    }



 // Load Summary Page
function loadSummary() {
    showSpinner(); // Show spinner before loading
    // Fetch filters (will get the default values now)
    var today = new Date();
    const month = document.getElementById('monthSummaryFilter')?.value || today.getMonth() + 1;
    const year = document.getElementById('yearSummaryFilter')?.value || today.getFullYear();
    const cacheKey = `${month}-${year}`;

      // Check for expiry
    if (summaryCache[cacheKey] && (Date.now() - summaryCache[cacheKey].timestamp < cacheExpiry)) {
      hideSpinner();
      renderSummary();

      return;
    }

    // Fetch summary data
    google.script.run.withSuccessHandler(function (data) {
      hideSpinner(); // Hide spinner on successful response
     
      if (data) {
        // Example cache entry structure
        summaryCache[cacheKey] = {
          timestamp: Date.now(),
          data: data
        };
        
        renderSummary(); // Render the page with fetched data
      }
      hideSpinner();

    })
    .withFailureHandler(function (error) {

      hideSpinner();
      alert('Failed to load summary. Please try again later.');
    })
    .getSummaryData(month, year);

}




function renderSummary(){
    // Fetch filters
  
  var today = new Date();
  const month = document.getElementById('monthSummaryFilter')?.value || today.getMonth() + 1;
  const year = document.getElementById('yearSummaryFilter')?.value || today.getFullYear();
  const cacheKey = `${month}-${year}`;
  let data = summaryCache[cacheKey].data;
  // Extract data
      const overBudgetCategories = data.overBudgetCategories || [];
      const underBudgetCategories = data.underBudgetCategories || [];
      const recentTransactions = data.recentTransactions || [];
      const totalIncome = data.totalIncome || '$0.00';
      const budgetVsActual = data.budgetVsActual || '$0.00';
      const spendingDataLabels = data.spendingData?.labels || [];
      const spendingDataValues = data.spendingData?.values || [];

      // Populate the page with updated content
      const content = `
        <div class="row">
          <div class="col-md-3">
            <select id="monthSummaryFilter" class="form-control">
              <option value="all">All Months</option>
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </div>
          <div class="col-md-3">
            <select id="yearSummaryFilter" class="form-control">
              <option value="all">All Years</option>
              <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
            <option value="2031">2031</option>
            <option value="2032">2032</option>
            <option value="2033">2033</option>
            <option value="2034">2034</option>
            <option value="2035">2035</option>
            </select>
          </div>
        </div>
        <div class="row mt-3">
          <!-- Spending Chart -->
          <div class="col-md-5">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Where is my money going?</h5>
                <div class="chart-container">
                   ${spendingDataLabels.length && spendingDataValues.length ? 
                    `<canvas id="moneyChart"></canvas>` : 
                    `<p>No data available</p>`
                  }
                </div>
              </div>
            </div>
          </div>
               <!-- recent transactions -->
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Recent Transactions</h5>
                <ul>${recentTransactions.map(cat => `<li>${cat}</li>`).join('')}</ul>
              </div>
            </div>
          </div>
       
          <!-- Overbudget Categories -->
          <div class="col-md-3">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Overbudget Categories</h5>
                <ul>${overBudgetCategories.map(cat => `<li>${cat}</li>`).join('')}</ul>
              </div>
            </div>
          </div>
          <!-- Underbudget Categories -->
          <div class="col-md-5">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Underbudget Categories</h5>
                <ul>${underBudgetCategories.map(cat => `<li>${cat}</li>`).join('')}</ul>
              </div>
            </div>
          </div>
        
          <!-- Total Income -->
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Total Income</h5>
                <p>${totalIncome}</p>
              </div>
            </div>
          </div>
          <!-- Budgeted vs Actual -->
          <div class="col-md-3">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Budgeted vs Actual</h5>
                <p>${budgetVsActual}</p>
              </div>
            </div>
          </div>
        </div>
      `;
      $('#main-content').html(content);


      // If there is data, initialize the chart
      if (spendingDataLabels.length && spendingDataValues.length) {
      var ctx = document.getElementById('moneyChart').getContext('2d');
      // Generate background colors based on the number of categories
      const backgroundColors = generateColors(spendingDataLabels.length);
      var moneyChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: spendingDataLabels,
          datasets: [{
            label: 'Spending Categories',
            data: spendingDataValues,
            backgroundColor: backgroundColors,
            borderColor: 'white',
            borderWidth: 1
          }]
        },
       options: {
    plugins: {
      legend: {
        labels: {
          color: 'white' // Set the legend label color to red
        }
      }
    }
  }
      });
      }

      // Set previously selected month and year back to the filters
      document.getElementById('monthSummaryFilter').value = month;
      document.getElementById('yearSummaryFilter').value = year;

  
      // Reattach event listeners for filters
      document.getElementById('monthSummaryFilter').addEventListener('change', loadSummary);
      document.getElementById('yearSummaryFilter').addEventListener('change', loadSummary);

}




  


// Function to render the income list
function renderIncome() {
  const month = document.getElementById('monthIncomeFilter').value;
  const year = parseInt(document.getElementById('yearIncomeFilter').value);
  
  let filteredIncome = incomes.filter(item => {
    const matchMonth = month ? item[2] === month : true;
    const matchYear = year ? item[3] === year : true;
    return matchMonth && matchYear;
  });

 
  

  const incomeList = $('#incomeList');
  incomeList.empty();

  if (filteredIncome.length > 0) {
    filteredIncome.forEach(item => {

         // Get the original index from the incomes array
      let originalIndex = incomes.findIndex(inc => inc[0] === item[0]); // Compare using ID or another unique field
      const listItem = `
        <li class="list-group-item mb-2 text-white d-flex justify-content-between align-items-center">
          <span>${item[5]} - $${item[4].toFixed(2)} (${item[2]}, ${item[3]})</span>
          <div>
            <button class="btn btn-sm btn-warning" onclick="editIncome(${originalIndex})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="confirmDeleteIncome('${item[0]}')">Delete</button>
          </div>
        </li>
      `;
      incomeList.append(listItem);
    });
  } else {
    incomeList.html('<li class="list-group-item text-muted">No income records for the selected filters.</li>');
  }
}


     // Add Income
    function addIncome() {
      showSpinner(); // Show spinner before loading
      let source = document.getElementById('incomeSource').value;
      let amount = parseFloat(document.getElementById('incomeAmount').value);
      let month = document.getElementById('incomeMonth').value;
      let year = document.getElementById('incomeYear').value;


    
     
      if (amount === null) {
        alert("Please enter a valid amount.");
        return;
      }

      if (month === '' || month == null) {
        alert("Please select a valid month.");
        return;
      }

      if (year === '' || year == null) {
        alert("Please select a valid year.");
        return;
      }


    // Call Google Apps Script to add the category
    google.script.run.withSuccessHandler(function(response) {
      hideSpinner(); // Show spinner before loading

      if (response === 'success') {

        alert('Income added successfully!');
         $('#addIncomeModal').modal('hide');

         //Invalidate the cache for the relevant month and year
       
        
        loadIncome(); // Reload the categories page to show updated list
        loadBadges(true); // Only refresh badges themselves, don't reload whole section
      } else {
        alert('Failed to add Income.');
      }
    }).addIncome(month, year, amount, source); // Call the addCategory function in Code.gs
    }

  function copyPreviousMonthIncome() {
  const currentMonth = document.getElementById('monthIncomeFilter').value;
  const currentYear = document.getElementById('yearIncomeFilter').value;

  if (!currentMonth || !currentYear) {
    alert("Please select both a month and year.");
    return;
  }

  showSpinner();

  google.script.run.withSuccessHandler(function(response) {
    hideSpinner();
    alert(response);
    loadIncome(); // Refresh income list after copying
  }).copyPreviousMonthIncome(currentMonth, parseInt(currentYear));
}

 function copyPreviousMonthPlan() {
  const currentMonth = document.getElementById('monthPlanFilter').value;
  const currentYear = document.getElementById('yearPlanFilter').value;

  if (!currentMonth || !currentYear) {
    alert("Please select both a month and year.");
    return;
  }

  showSpinner();

  google.script.run.withSuccessHandler(function(response) {
    hideSpinner();
    alert(response);
    loadPlans(); // Refresh income list after copying
  }).copyPreviousMonthPlan(currentMonth, parseInt(currentYear));
}



    


  function renderCategories() {
    const searchTerm = document.getElementById('categorySearch').value.toLowerCase();
    let categoryList = $('#categoryList');
    categoryList.empty(); // Clear existing list

    const filteredCategories= categories.filter(item => {
   
    const matchSearch = searchTerm ? item[1].toLowerCase().includes(searchTerm) : true; // Assuming name/desc is item[1]
    return  matchSearch;
  });

  
  filteredCategories.forEach(function(category, filteredIndex) {
    // Get the original index from the categories array
    let originalIndex = categories.findIndex(function(cat) {
      return cat[0] === category[0]; // Compare based on category name or ID (modify as per your data structure)
    });


    categoryList.append(`
      <li class="list-group-item d-flex mb-2 text-white justify-content-between align-items-center">
        ${category[1]}
        <div>
          <button class="btn btn-warning btn-sm" onclick="editCategory(${originalIndex})">Edit</button>
          <button class="btn btn-danger btn-sm" onclick="confirmDeleteCategory('${category[0]}')">Delete</button>
        </div>
      </li>
    `);
  });



}






// Function to filter categories based on search term
function filterCategories(searchTerm) {
  // Filter categories array by name
  let filteredCategories = categories.filter(function(category) {
    return category[1].toLowerCase().includes(searchTerm);
  });

  // Render the filtered categories
  renderCategories(filteredCategories);
}

  // Function to handle adding a new category
  function addCategory() {
    showSpinner(); // Show spinner before loading
    let categoryName = document.getElementById('categoryName').value;
    if (categoryName.trim() === "") {
      alert("Please enter a valid category name.");
      return;
    }

    // Call Google Apps Script to add the category
    google.script.run.withSuccessHandler(function(response) {
      hideSpinner(); // Show spinner before loading

      if (response === 'success') {

        alert('Category added successfully!');
        $('#addCategoryModal').modal('hide'); // Close the modal

        // Invalidate the cache for the relevant month and year
    
        loadCategories(); // Reload the categories page to show updated list
      } else {
        alert('Failed to add category.');
      }
    }).addCategory(categoryName); // Call the addCategory function in Code.gs
  }
 

function editCategory(index) {
  // Store the index of the category being edited
  currentCategoryId = index; // Make sure `currentCategoryId` is a global variable or scoped where needed

  // Populate the modal input field with the current category name
  $('#editCategoryName').val(categories[index][1]);

  // Show the edit modal
  $('#editCategoryModal').modal('show');
}


function editIncome(index) {
  // Store the index of the income being edited
  currentIncomeId = index; // Make sure `currentIncomeId` is a global variable or scoped where needed

  // Populate the modal input field with the current incomes values
  $('#editIncomeMonth').val(incomes[index][2]);
  $('#editIncomeYear').val(incomes[index][3]);
  $('#editIncomeAmount').val(incomes[index][4]);
  $('#editIncomeSource').val(incomes[index][5]);


  // Show the edit modal
  $('#editIncomeModal').modal('show');
}

function editTransaction(index) {
  // Store the index of the income being edited
  currentTransactionId = index; // Make sure `currentTransactionId` is a global variable or scoped where needed

  // Populate the modal input field with the current incomes values
  $('#editTransactionDesc').val(transactions[index][4]);

  $('#editTransactionAmount').val(transactions[index][3]);






  // Show the edit modal
  $('#editTransactionModal').modal('show');







}


function editPlan(index) {
  // Store the index of the plan being edited
  currentPlanId = index; // Make sure `currentPlanId` is a global variable or scoped where needed

  // Populate the modal input field with the current plan values
  $('#editPlanMonth').val(plans[index][2]);
  $('#editPlanYear').val(plans[index][3]);
  $('#editPlanAmount').val(plans[index][4]);
  $('#editPlanSource').val(plans[index][6]);

  
 

  
  // Show the edit modal
  $('#editPlanModal').modal('show');

     // Populate categories and set the selected value
  populatePlanEditCategoriesDropdown(() => {
    $('#editPlanCategory').val(plans[index][5]); // Set selected category
  });



 



  
}






// Optional: Reset the modal on close to avoid stale data
$('#editCategoryModal').on('hidden.bs.modal', function () {
  $('#editCategoryName').val('');
});

// Optional: Reset the modal on close to avoid stale data
$('#editIncomeModal').on('hidden.bs.modal', function () {
  $('#editIncomeMonth').val('');
  $('#editIncomeYear').val('');
  $('#editIncomeAmount').val('');
  $('#editIncomeSource').val('');
});

// Optional: Reset the modal on close to avoid stale data
$('#editPlanModal').on('hidden.bs.modal', function () {
  $('#editPlanMonth').val('');
  $('#editPlanYear').val('');
  $('#editPlanAmount').val('');
  $('#editPlanSource').val('');
  $('#editPlanCategory').val('');
});

// Optional: Reset the modal on close to avoid stale data
$('#editTransactionModal').on('hidden.bs.modal', function () {

  $('#editTransactionAmount').val('');
  $('#editTransactionDesc').val('');
});


$('#addCategoryModal').on('hidden.bs.modal', function () {
  $('#categoryName').val('');
});

// Optional: Reset the modal on close to avoid stale data
$('#addIncomeModal').on('hidden.bs.modal', function () {
  $('#incomeMonth').val('');
  $('#incomeYear').val('');
  $('#incomeAmount').val('');
  $('#incomeSource').val('');
});

// Optional: Reset the modal on close to avoid stale data
$('#addPlanModal').on('hidden.bs.modal', function () {
  $('#planMonth').val('');
  $('#planYear').val('');
  $('#planAmount').val('');
  $('#planSource').val('');
  $('#planCategory').val('');
  $('#planSystemCategory').val('');
});

// Optional: Reset the modal on close to avoid stale data
$('#addTransactionModal').on('hidden.bs.modal', function () {
 
  $('#transactionAmount').val('');
  $('#transactionDesc').val('');


});






function updateCategory() {
  showSpinner(); // Show spinner before loading
  // Get the updated category name from the modal input field
  let updatedName = $('#editCategoryName').val().trim();

  // Validate the input
  if (updatedName === '') {
    alert('Category name cannot be empty.');
    return;
  }

  // Send the updated data to the backend
  google.script.run.withSuccessHandler(function(response) {
    hideSpinner(); // Show spinner before loading
    if (response === 'success') {
      alert('Category updated successfully!');
      $('#editCategoryModal').modal('hide'); // Close the modal
  
      loadCategories(); // Reload the categories list
    } else {
      alert('Failed to update category.');
    }
  }).editCategory(categories[currentCategoryId][0], updatedName); // Call the backend function
  
}

function updateTransaction() {
  showSpinner(); // Show spinner before loading
  // Get the updated values from the modal input field
  let updatedDesc = $('#editTransactionDesc').val().trim();
  let updatedAmount = $('#editTransactionAmount').val();


  

  // Validate the input

  if (isNaN(updatedAmount) || updatedAmount <= 0) {
      alert("Please enter a valid amount greater than 0.");
      hideSpinner();
      return;
  }

 

  if (updatedDesc === '' || updatedDesc == null) {
    alert('Description cannot be empty.');
    hideSpinner();
    return;
  }

  const plan = plans.find(item => item[0] === currentPlanId); 
  const systemCategory = plan?.[7];
  const category = plan?.[5];

  // Send the updated data to the backend
  google.script.run.withSuccessHandler(function(response) {
    hideSpinner(); // Show spinner before loading
    if (response === 'success') {
      alert('Transaction updated successfully!');
      $('#editTransactionModal').modal('hide'); // Close the modal
      // Invalidate the cache for the relevant month and year
      const cacheKey = `${currentPlanId}-transactions`;
      delete transactionsCache[cacheKey];
      viewPlanTransactions(currentPlanId);
     
    } else {
      alert('Failed to update transaction item.');
    }
  }).editTransaction(transactions[currentTransactionId][0], currentPlanId, updatedAmount, updatedDesc, category, systemCategory); // Call the backend function
  
}

function updateIncome() {
  showSpinner(); // Show spinner before loading
  // Get the updated Income Month from the modal input field
  let updatedMonth = $('#editIncomeMonth').val().trim();
  let updatedYear = $('#editIncomeYear').val();
  let updatedAmount = $('#editIncomeAmount').val();
  let updatedSource = $('#editIncomeSource').val().trim();
  

  // Validate the input
  if (updatedMonth === '') {
    alert('Month cannot be empty.');
    return;
  }

  if (updatedYear === null || updatedYear === '') {
    alert('Year cannot be empty.');
    return;
  }

  if (updatedAmount === null  || updatedAmount === '') {
    alert('Amount cannot be empty.');
    return;
  }

  if (updatedSource === '') {
    alert('Description cannot be empty.');
    return;
  }

  // Send the updated data to the backend
  google.script.run.withSuccessHandler(function(response) {
    hideSpinner(); // Show spinner before loading
    if (response === 'success') {
      alert('Income updated successfully!');
      $('#editIncomeModal').modal('hide'); // Close the modal


      loadIncome(); // Reload the categories list
    } else {
      alert('Failed to update income.');
    }
  }).editIncome(incomes[currentIncomeId][0], updatedMonth, updatedYear, updatedAmount, updatedSource); // Call the backend function
  
}


// Function to open the delete confirmation modal
function confirmDeleteCategory(index) {
  categoryToDelete = index; // Store the index of the category to be deleted
  $('#deleteCategoryModal').modal('show'); // Show the modal
}

function confirmDeleteIncome(index){
  incomeToDelete = index;
  $('#deleteIncomeModal').modal('show');
}


function confirmDeletePlan(index){
  planToDelete = index;
  $('#deletePlanModal').modal('show');
}


function confirmDeleteTransaction(index){
  transactionToDelete = index;
  $('#deleteTransactionModal').modal('show');

}


    // Delete Category
function deleteCategory() {
      showSpinner(); // Show spinner before loading
      if (categoryToDelete !== null) {
      categories.splice(categoryToDelete, 1);

       // Send the updated data to the backend
      google.script.run.withSuccessHandler(function(response) {
      hideSpinner(); // Show spinner before loading
    
      if (response === 'success') {
      alert('Category deleted successfully!');

      loadCategories();
       $('#deleteCategoryModal').modal('hide'); // Close the modal
    } else {
      alert('Failed to delete category.');
    }
  }).deleteCategory(categoryToDelete); // Call the backend function
      }
      
  }

      // Delete Income
function deleteIncome() {
      showSpinner(); // Show spinner before loading
      if (incomeToDelete !== null) {
      incomes.splice(incomeToDelete, 1);

       // Send the updated data to the backend
      google.script.run.withSuccessHandler(function(response) {
      hideSpinner(); // Show spinner before loading

      if (response === 'success') {
      alert('Income item deleted successfully!');
   

      loadIncome();
       $('#deleteIncomeModal').modal('hide'); // Close the modal
    } else {
      alert('Failed to delete income item.');
    }
  }).deleteIncome(incomeToDelete); // Call the backend function
      }
      
  }

        // Delete Plan
function deletePlan() {
      showSpinner(); // Show spinner before loading
      if (planToDelete !== null) {
      plans.splice(planToDelete, 1);

       // Send the updated data to the backend
      google.script.run.withSuccessHandler(function(response) {
      hideSpinner(); // Show spinner before loading

      if (response === 'success') {
      alert('Plan item deleted successfully!');
   
      loadPlans();
       $('#deletePlanModal').modal('hide'); // Close the modal
    } else {
      alert('Failed to delete plan item.');
    }
  }).deletePlan(planToDelete); // Call the backend function
      }
      
  }


// Delete Transaction
function deleteTransaction() {
      showSpinner(); // Show spinner before loading
      if (transactionToDelete !== null) {
      transactions.splice(transactionToDelete, 1);

       // Send the updated data to the backend
      google.script.run.withSuccessHandler(function(response) {
      hideSpinner(); // Show spinner before loading
    
      if (response === 'success') {
      alert('Transaction item deleted successfully!');
      // Invalidate the cache for the relevant month and year
      const cacheKey = `${currentPlanId}-transactions`;
      delete transactionsCache[cacheKey];
      viewPlanTransactions(currentPlanId);
       $('#deleteTransactionModal').modal('hide'); // Close the modal
    } else {
      alert('Failed to delete transaction item.');
    }
  }).deleteTransaction(transactionToDelete); // Call the backend function
      }
      
  }

  // Add event listener to the confirm delete button
$('#confirmDeleteCategoryBtn').on('click', function() {
  
  deleteCategory();
});

  // Add event listener to the confirm delete button
$('#confirmDeleteIncomeBtn').on('click', function() {
  
  deleteIncome();
});

  // Add event listener to the confirm delete button
$('#confirmDeletePlanBtn').on('click', function() {
  
  deletePlan();
});

  // Add event listener to the confirm delete button
$('#confirmDeleteTransactionBtn').on('click', function() {
  
  deleteTransaction();
});




function renderPlan() {
  const month = document.getElementById('monthPlanFilter').value;
  const year = parseInt(document.getElementById('yearPlanFilter').value);
  const searchTerm = document.getElementById('planSearch').value.toLowerCase();

  const filteredPlans = plans.filter(item => {
    const matchMonth = month ? item[2] === month : true;
    const matchYear = year ? item[3] === year : true;
    const matchSearch = searchTerm ? item[5].toLowerCase().includes(searchTerm) : true; // Assuming name/desc is item[5]
    return matchMonth && matchYear && matchSearch;
  });

  const planList = $('#planList');
  planList.empty();

  if (filteredPlans.length > 0) {
    filteredPlans.forEach(item => {
      // Get the original index from the incomes array
      let originalIndex = plans.findIndex(inc => inc[0] === item[0]); // Compare using ID or another unique field
      const listItem = `
        <li class="list-group-item mb-2 text-white d-flex justify-content-between align-items-center">
          <span>${item[5]} - $${item[4].toFixed(2)} (${item[2]}, ${item[3]})</span>
          <div>
            <button class="btn btn-sm btn-info text-white" onclick="viewPlanTransactions('${item[0]}')">View Transactions</button>
            <button class="btn btn-sm btn-warning" onclick="editPlan(${originalIndex})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="confirmDeletePlan('${item[0]}')">Delete</button>
          </div>
        </li>
      `;
      planList.append(listItem);
    });
  } else {
    planList.html('<li class="list-group-item text-muted">No plans found for the selected filters.</li>');
  }
}

function viewPlanTransactions(planId) {
  showSpinner();
  const cacheKey = `${planId}-transactions`;
  currentPlanId = planId;
  if (transactionsCache[cacheKey]) {
    // Use cached data
    transactions = transactionsCache[cacheKey];
    loadTransactions(planId, transactions);
    hideSpinner();
    return;
  }
  // Fetch transactions and load the details page
  google.script.run.withSuccessHandler(function(response) {
    hideSpinner();
    if (response && Array.isArray(response)) {
      transactions = response; // Initialize or update the global income array
      transactionsCache[cacheKey] = transactions; // Cache the result
      loadTransactions(planId, response); // Pass planId and fetched transactions to load page
    }
  }).getTransactionsByPlan(planId); // Backend function to fetch transactions for the plan
}

function loadTransactions(planId, transactions) {
  const plan = plans.find(item => item[0] === planId);
  

  const content = `
    <h3>Transactions for ${plan[5]} (${plan[2]}, ${plan[3]})</h3>
       <div class="button-container">
      <button class="btn btn-secondary mb-3" onclick="loadPlans()">Back to Plans</button>
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addTransactionModal"
    data-plan-name="${plan[5]} (${plan[2]}, ${plan[3]})">Add Transaction</button>
    <button class="btn btn-secondary mb-3" onclick="updateRemainingPlanItemAmountDisplay()">Calculate Remaining Plan Item</button>
    </div>
       <div id="remainingPlanItemAmountDisplay" class="alert alert-info">
  Remaining Plan Item Amount: $0.00
</div>
   
    <ul class="list-group" id="transactionList"></ul>

  `;
  $('#main-content').html(content);

 


  const transactionList = $('#transactionList');
  transactionList.empty();

  if (transactions.length > 0) {

    transactions.forEach(item => {

    let originalIndex = transactions.findIndex(inc => inc[0] === item[0]); // Compare using ID or another unique field
  
 
      const listItem = `
        <li class="list-group-item mb-2 text-white d-flex justify-content-between align-items-center">
          <span>${item[4]} - $${item[3].toFixed(2)} (${item[2]})</span>
          <div>
            <button class="btn btn-sm btn-warning" onclick="editTransaction(${originalIndex})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="confirmDeleteTransaction('${item[0]}')">Delete</button>
          </div>
        </li>
      `;
      transactionList.append(listItem);
    });
  } else {
    transactionList.html('<li class="list-group-item text-muted">No transactions for this plan.</li>');
  }
}

// Add Plan
    function addTransaction() {
      showSpinner(); // Show spinner before loading
   
      let desc = document.getElementById('transactionDesc').value;
      let amount = parseFloat(document.getElementById('transactionAmount').value);
     

    
 

    
     
      if (isNaN(amount) || amount <= 0) {
        alert("Please enter a valid amount greater than 0.");
        hideSpinner();
        return;
      }

      const plan = plans.find(item => item[0] === currentPlanId); 
      const systemCategory = plan?.[7];
      const category = plan?.[5];

     
      

  

      if (desc === '' || desc == null) {
        alert("Please enter in a description.");
        hideSpinner();
        return;
      }


    // Call Google Apps Script to add the category
    google.script.run.withSuccessHandler(function(response) {
      hideSpinner(); // Show spinner before loading
  
      if (response === 'success') {

        alert('Transaction added successfully!');
     
         $('#addTransactionModal').modal('hide');

         // Invalidate the cache for the relevant month and year
        const cacheKey = `${currentPlanId}-transactions`;
        delete transactionsCache[cacheKey];
        viewPlanTransactions(currentPlanId); // Reload the Plans page to show updated list
   
        loadBadges(true); // Only refresh badges themselves, don't reload whole section
      
      } else {
        alert('Failed to add transaction.');
      }
    }).addTransaction(currentPlanId, amount, desc, category, systemCategory); // Call the addTransaction function in Code.gs
    }


 // Add Plan
    function addPlan() {
      showSpinner(); // Show spinner before loading
      let category = document.getElementById('planCategory').value;
      let systemCategory = document.getElementById('planSystemCategory').value;
      let desc = document.getElementById('planSource').value;
      let amount = parseFloat(document.getElementById('planAmount').value);
      let month = document.getElementById('planMonth').value;
      let year = document.getElementById('planYear').value;


    
     
      if (amount === null) {
        alert("Please enter a valid amount.");
        return;
      }

  
      if (month === '' || month == null) {
        alert("Please select a valid month.");
        return;
      }

      if (year === '' || year == null) {
        alert("Please select a valid year.");
        return;
      }

      if (category === '' || category == null) {
        alert("Please select a valid category.");
        return;
      }


    // Call Google Apps Script to add the category
    google.script.run.withSuccessHandler(function(response) {
      hideSpinner(); // Show spinner before loading
      if (response === 'success') {

        alert('Plan added successfully!');
         $('#addPlanModal').modal('hide');

     
        
        loadPlans(); // Reload the Plans page to show updated list
        loadBadges(true); // Only refresh badges themselves, don't reload whole section
      } else {
        alert('Failed to add Plan.');
      }
    }).addPlan(month, year, amount, category, desc, systemCategory); // Call the addCategory function in Code.gs
    }

  function updatePlan() {
  showSpinner(); // Show spinner before loading
  // Get the updated Income Month from the modal input field
  let updatedCategory = document.getElementById('editPlanCategory').value;
  let updatedSystemCategory = document.getElementById('editPlanSystemCategory').value;
  let updatedDesc = document.getElementById('editPlanSource').value;
  let updatedAmount = document.getElementById('editPlanAmount').value;
  let updatedMonth = document.getElementById('editPlanMonth').value;
  let updatedYear = document.getElementById('editPlanYear').value;

   
  // Validate the input
       
      if (updatedAmount === null) {
        alert("Please enter a valid amount.");
        return;
      }

  
      if (updatedMonth === '' || updatedMonth == null) {
        alert("Please select a valid month.");
        return;
      }

      if (updatedYear === '' || updatedYear == null) {
        alert("Please select a valid year.");
        return;
      }

      if (updatedCategory === '' || updatedCategory == null) {
        alert("Please select a valid category.");
        return;
      }

  // Send the updated data to the backend
  google.script.run.withSuccessHandler(function(response) {
    hideSpinner(); // Show spinner before loading
    if (response === 'success') {
      alert('Plan updated successfully!');
      $('#editPlanModal').modal('hide'); // Close the modal
   
      loadPlans(); // Reload the categories list
    } else {
      alert('Failed to update plan.');
    }
  }).editPlan(plans[currentPlanId][0], updatedMonth, updatedYear, updatedAmount, updatedCategory, updatedDesc, updatedSystemCategory); // Call the backend function
  
}


function populateIncomesArray() {
  const month = document.getElementById('monthPlanFilter').value || 'All';
  const year = parseInt(document.getElementById('yearPlanFilter').value) || 'All';
  const cacheKey = `${month}-${year}`;
  
  if (incomesCache[cacheKey]) {
    // Use cached data if available
    incomes = incomesCache[cacheKey];
    updateRemainingIncomeAmountDisplay();  // Make sure remaining income is updated if using cached data
    return;
  }

  // Fetch new income data from the server if no cached data is available
  google.script.run.withSuccessHandler(function(response) {
    if (response != null && Array.isArray(response)) {
      incomes = response;
      // Cache the fetched data for later use
      incomesCache[cacheKey] = incomes;
      updateRemainingIncomeAmountDisplay();  // Update the remaining income display
    }
  }).withFailureHandler(function(error) {

  }).getIncome(month, year);  // Call the getIncome function in Code.gs
}




function populatePlanAddCategoriesDropdown() {
  const dropdown = document.getElementById('planCategory');
   if (!dropdown) {

    return;
  }

  dropdown.innerHTML = ''; // Clear any existing options
   // Add a "Loading..." option while waiting for the response
  const loadingOption = document.createElement('option');
  loadingOption.value = '';
  loadingOption.textContent = 'Loading...';
  dropdown.appendChild(loadingOption);

 

   google.script.run.withSuccessHandler(function(response) {
      dropdown.innerHTML = '';
    
      if (response != null && Array.isArray(response)) {
      categories = response;
      // Add a default option
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Select Category';
      dropdown.appendChild(defaultOption);

      // Populate categories
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category[1];
        option.textContent = category[1];
        dropdown.appendChild(option);
      });
       
      } 
    
    }).getCategories(); // Call the addCategory function in Code.gs
}

function populatePlanAddSystemCategoriesDropdown() {
  const dropdown = document.getElementById('planSystemCategory');
   if (!dropdown) {

    return;
  }

  dropdown.innerHTML = ''; // Clear any existing options
   // Add a "Loading..." option while waiting for the response
  const loadingOption = document.createElement('option');
  loadingOption.value = '';
  loadingOption.textContent = 'Loading...';
  dropdown.appendChild(loadingOption);

 

   google.script.run.withSuccessHandler(function(response) {
      dropdown.innerHTML = '';
    
      if (response != null && Array.isArray(response)) {
      categories = response;
      // Add a default option
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Select Category';
      dropdown.appendChild(defaultOption);

      // Populate categories
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category[1];
        option.textContent = category[1];
        dropdown.appendChild(option);
      });
       
      } 
   
    }).getSystemCategories(); // Call the addCategory function in Code.gs
}

function populatePlanEditSystemCategoriesDropdown(callback) {
  const dropdown = document.getElementById('editPlanSystemCategory');

  if (!dropdown) {

    return;
  }


  dropdown.innerHTML = ''; // Clear any existing options
   // Add a "Loading..." option while waiting for the response
  const loadingOption = document.createElement('option');
  loadingOption.value = '';
  loadingOption.textContent = 'Loading...';
  dropdown.appendChild(loadingOption);
 
   
   google.script.run.withSuccessHandler(function(response) {
      // Remove the "Loading..." option
      dropdown.innerHTML = '';
      if (response != null && Array.isArray(response)) {
      categories = response;
      // Add a default option
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Select Category';
      dropdown.appendChild(defaultOption);

      // Populate categories
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category[1];
        option.textContent = category[1];
        dropdown.appendChild(option);
      });

       // Execute the callback if provided
      if (callback)
       callback();
      } 
   
    }).getSystemCategories(); // Call the addCategory function in Code.gs
}

function populatePlanEditCategoriesDropdown(callback) {
  const dropdown = document.getElementById('editPlanCategory');

  if (!dropdown) {

    return;
  }


  dropdown.innerHTML = ''; // Clear any existing options
   // Add a "Loading..." option while waiting for the response
  const loadingOption = document.createElement('option');
  loadingOption.value = '';
  loadingOption.textContent = 'Loading...';
  dropdown.appendChild(loadingOption);
 
   
   google.script.run.withSuccessHandler(function(response) {
      // Remove the "Loading..." option
      dropdown.innerHTML = '';
      if (response != null && Array.isArray(response)) {
      categories = response;
      // Add a default option
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Select Category';
      dropdown.appendChild(defaultOption);

      // Populate categories
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category[1];
        option.textContent = category[1];
        dropdown.appendChild(option);
      });

       // Execute the callback if provided
      if (callback)
       callback();
      } 
    
    }).getCategories(); // Call the addCategory function in Code.gs
}

// Call this function when the page loads or the modal is shown
$('#addTransactionModal').on('show.bs.modal', function (e) {
  const modal = $(this);
  const button = $(e.relatedTarget); 
  const planName = button.data('plan-name'); 
  updateModalTitle('addTransactionModal', 'Add Transaction to', planName);

});



// Call this function when the page loads or the modal is shown
$('#editTransactionModal').on('show.bs.modal', function (e) {
  
  const modal = $(this);
  const plan = plans.find(item => item[0] === currentPlanId); // currentPlanId assumed globally available



});







// Call this function when the page loads or the modal is shown
$('#addPlanModal').on('show.bs.modal', function (e) {
  const modal = $(this);
    // Avoid re-populating if already populated
  if (!modal.data('categoriesLoaded')) {
    populatePlanAddCategoriesDropdown(() => {
      modal.data('categoriesLoaded', true); // Mark as loaded
    });
   
  } 

  if(!modal.data('systemCategoriesLoaded')){
     populatePlanAddSystemCategoriesDropdown(() => {
      modal.data('systemCategoriesLoaded', true); // Mark as loaded
    });
  }

});

$('#editPlanModal').on('show.bs.modal', function () {
  const modal = $(this);

  // Avoid re-populating if already populated
  if (!modal.data('categoriesLoaded')) {
    populatePlanEditCategoriesDropdown(() => {
      $('#editPlanCategory').val(plans[currentPlanId][5]);
      modal.data('categoriesLoaded', true); // Mark as loaded
    });
  } 

  if(!modal.data('systemCategoriesLoaded')){
    populatePlanEditSystemCategoriesDropdown(() => {
      $('#editPlanSystemCategory').val(plans[currentPlanId][5]);
      modal.data('systemCategoriesLoaded', true); // Mark as loaded
    });
  }
 
});

function filterDataByMonthAndYear(data, month, year) {
  return data.filter(item => {
    const matchMonth = month ? item[2] === month : true; // Assuming month is stored in index 2
    const matchYear = year ? item[3] === year : true;   // Assuming year is stored in index 3
    return matchMonth && matchYear;
  });
}

function filterDataById(data, id) {
  return data.filter(item => {
    const matchId = id ? item[0] === id : true; 
    const matchTransactionPlanId = id ? item[1] === id : true; 
    return matchId || matchTransactionPlanId;
  });
}
function calculateTotalIncome(filteredIncome) {
  return filteredIncome.reduce((total, income) => total + income[4], 0); // Assuming amount is in index 4
}

function calculateTotalTransactions(filteredTransactions) {
  return filteredTransactions.reduce((total, transaction) => total + transaction[3], 0); // Assuming amount is in index 4
}

function calculateTotalPlanned(filteredPlans) {
  return filteredPlans.reduce((total, plan) => total + plan[4], 0); // Assuming amount is in index 4
}


function calculateRemainingIncomeAmount(month, year, callback) {
   // Fetch all income data and all plans data
  getAllIncomeByMonthAndYear(month, year, function(totalIncome) {
    getAllPlansByMonthAndYear(month, year, function(totalPlanned) {
      const remainingIncome = totalIncome - totalPlanned;
      callback(remainingIncome); // Return the final result via callback
    });
  });



}

function calculateRemainingPlanItemAmount(id) {
  const filteredTransactions = filterDataById(transactions, id);
  const filteredPlans = filterDataById(plans, id);

  const totalTransactions = calculateTotalTransactions(filteredTransactions);
  const totalPlanned = calculateTotalPlanned(filteredPlans);

  return totalPlanned - totalTransactions;
}


function updateRemainingIncomeAmountDisplay() {
  const month = document.getElementById('monthPlanFilter').value;
  const year = document.getElementById('yearPlanFilter').value;

  const remainingAmount = calculateRemainingIncomeAmount(month, year, function(remainingIncome) {

    // Update the UI or perform further actions here

    if(document.getElementById('remainingIncomeAmountDisplay')){
      document.getElementById('remainingIncomeAmountDisplay').textContent = `Remaining Income Amount: $${remainingIncome.toFixed(2)}`;

    }
    
  
          
  })



}

function updateRemainingPlanItemAmountDisplay() {
  

  const remainingAmount = calculateRemainingPlanItemAmount(currentPlanId);

  document.getElementById('remainingPlanItemAmountDisplay').textContent = 
    `Remaining Plan Item Amount: $${remainingAmount.toFixed(2)}`;
}



function debounce(func, wait) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

function loadIncome(){
   showSpinner(); // Show spinner before loading

   // Get the current date
  const today = new Date();
  const currentMonth = monthNames[today.getMonth()];
  const currentYear = today.getFullYear();
  const content = `
    <h3>Income</h3>
    <div class="row mb-3">
      <div class="col-md-3">
        <select id="monthIncomeFilter" class="form-control" onchange="goToIncomePage(1)">
       <option value="">All Months</option>
          ${monthNames.map(month => `<option value="${month}">${month}</option>`).join('')}
        </select>
      </div>
      <div class="col-md-3">
        <select id="yearIncomeFilter" class="form-control" onchange="goToIncomePage(1)">
          <option value="">All Years</option>
          <option value="2024">2024</option>
          <option value="2025">2025</option>
        </select>
      </div>
         <!-- Search Bar -->
      <div class="col-md-6">
        <input type="text" id="incomeSearch" class="form-control" placeholder="Search by name" onkeyup="goToIncomePage(1)">
      </div>
    </div>
         <div class="button-container">
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addIncomeModal">Add Income</button>
    <button class="btn btn-secondary mb-3" onclick="copyPreviousMonthIncome()">Copy Previous Month</button>
    </div>
    <ul class="list-group" id="incomeList"></ul>
       <!-- Pagination Controls -->
    <div id="paginationControls" class="d-flex justify-content-between align-items-center pagination-spacing mt-3">
      <button id="prevPage" class="btn btn-secondary" disabled onclick="goToIncomePage(currentPage - 1)">Previous</button>
      <span>Page <input id="currentPageInput" type="number" value="1" min="1" style="width: 50px;" onchange="goToSpecificIncomePage()"> of <span id="totalPages">1</span></span>
      <button id="nextPage" class="btn btn-secondary" disabled onclick="goToIncomePage(currentPage + 1)">Next</button>
    </div>
  `;

  

 

  $('#main-content').html(content);
  // Get the filter elements
  const monthFilter = document.getElementById('monthIncomeFilter');
  const yearFilter = document.getElementById('yearIncomeFilter');

  // Only set the default values if the filters are not already set (i.e., not modified by the user)
  if (!monthFilter.value) {
    monthFilter.value = currentMonth; // Set default to current month if not selected
  }
  if (!yearFilter.value) {
    yearFilter.value = currentYear.toString(); // Set default to current year if not selected
  }
    // Initial data load
  goToIncomePage(1); // Load the first page by default

}

function loadCategories(){
     showSpinner(); // Show spinner before loading
      const content = `
        <h3>Categories</h3>
        
        <input type="text" id="categorySearch" class="form-control mb-3" placeholder="Search categories"
        onkeyup="goToCategoryPage(1)">
              <div class="button-container">
        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addCategoryModal">Add Category</button>
        </div>
     
        <ul class="list-group" id="categoryList"></ul>
             <!-- Pagination Controls -->
    <div id="paginationControls" class="d-flex justify-content-between align-items-center mt-3 pagination-spacing">
      <button id="prevPage" class="btn btn-secondary" disabled onclick="goToCategoryPage(currentPage - 1)">Previous</button>
      <span>Page <input id="currentPageInput" type="number" value="1" min="1" style="width: 50px;" onchange="goToSpecificCategoryPage()"> of <span id="totalPages">1</span></span>
      <button id="nextPage" class="btn btn-secondary" disabled onclick="goToCategoryPage(currentPage + 1)">Next</button>
    </div>
      `;
      $('#main-content').html(content);
        // Initial data load
  goToCategoryPage(1); // Load the first page by default
}


function loadBadges(onlyRender = false) {
  showSpinner();

      if (!onlyRender) {
    const content = `
      <h3>Badges</h3>
        <input type="text" id="badgeSearch" class="form-control mb-3" placeholder="Search badges"
        onkeyup="goToBadgePage(1)">
      <div id="badges" class="row mt-3"></div>
                  <!-- Pagination Controls -->
    <div id="paginationControls" class="d-flex justify-content-between align-items-center mt-3 pagination-spacing">
      <button id="prevPage" class="btn btn-secondary" disabled onclick="goToBadgePage(currentPage - 1)">Previous</button>
      <span>Page <input id="currentPageInput" type="number" value="1" min="1" style="width: 50px;" onchange="goToSpecificBadgePage()"> of <span id="totalPages">1</span></span>
      <button id="nextPage" class="btn btn-secondary" disabled onclick="goToBadgePage(currentPage + 1)">Next</button>
    </div>
    `;
     
    $('#main-content').html(content);
     }
    goToBadgePage(1, true); // Load the first page by default
 
}



function formatEarnedDate(dateString) {
  if (!dateString) return '';

  const date = new Date(dateString);
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  
  return `Earned on ${date.toLocaleDateString(undefined, options)}`;
}

function renderBadges(badges) {
  const container = $('#badges');
  container.empty();

  badges.forEach(badge => {
    const earnedDateText = badge.earned ? `<p class="mt-2" style="font-size: 0.9rem; color: lightgray;">${formatEarnedDate(badge.earnedDate)}</p>` : '';

    const badgeCard = `
      <div class="col-md-4">
        ${badge.earned 
          ? `<div class="card" style="opacity: 1; background-color: #495057;">` 
          : `<div class="card" style="opacity: .5; background-color: #495057;">`}
          <div class="card-body text-center">
            <div style="font-size: 3rem;">${badge.image || ''}</div>
            <h5 class="card-title mt-2">${badge.title}</h5>
            <p class="card-text" style="min-height: 60px;">${badge.description}</p>
            ${earnedDateText}
            ${badge.earned 
              ? `<button class="btn btn-success btn-sm mt-2" disabled>Earned</button>` 
              : `<button class="btn btn-secondary btn-sm mt-2" disabled>Locked</button>`}
          </div>
        </div>
      </div>
    `;
    container.append(badgeCard);
  });
}




function loadPlans() {
  showSpinner(); // Show spinner before loading

  // Get the current date
  const today = new Date();
  


  

  const currentMonth = monthNames[today.getMonth()];
  const currentYear = today.getFullYear();
  // Content for filters, buttons, and pagination
  const content = `
    <h3>Plan</h3>
    <div class="row mb-3">
      <!-- Month and Year Filters -->
      <div class="col-md-3">
        <select id="monthPlanFilter" class="form-control" onchange="goToPlanPage(1)">
         <option value="">All Months</option>
          ${monthNames.map(month => `<option value="${month}">${month}</option>`).join('')}
        </select>
      </div>
      <div class="col-md-3">
        <select id="yearPlanFilter" class="form-control" onchange="goToPlanPage(1)">
          <option value="">All Years</option>
          <option value="2024">2024</option>
          <option value="2025">2025</option>
        </select>
      </div>
      <!-- Search Bar -->
      <div class="col-md-6">
        <input type="text" id="planSearch" class="form-control" placeholder="Search by name or description" onkeyup="goToPlanPage(1)">
      </div>
    </div>
    <!-- Buttons -->
    <div class="button-container">
      <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addPlanModal">Add Plan</button>
      <button class="btn btn-secondary mb-3" onclick="copyPreviousMonthPlan()">Copy Previous Month</button>
      <button class="btn btn-secondary mb-3" onclick="updateRemainingIncomeAmountDisplay()">Calculate Remaining Income</button>
    </div>
    <div id="remainingIncomeAmountDisplay" class="alert alert-info">
      Remaining Income Amount: $0.00
    </div>
    <!-- Plan List -->
    <ul class="list-group" id="planList"></ul>
    <!-- Pagination Controls -->
    <div id="paginationControls" class="d-flex justify-content-between align-items-center mt-3 pagination-spacing">
      <button id="prevPage" class="btn btn-secondary" disabled onclick="goToPlanPage(currentPage - 1)">Previous</button>
      <span>Page <input id="currentPageInput" type="number" value="1" min="1" style="width: 50px;" onchange="goToSpecificPlanPage()"> of <span id="totalPages">1</span></span>
      <button id="nextPage" class="btn btn-secondary" disabled onclick="goToPlanPage(currentPage + 1)">Next</button>
    </div>
  `;
  $('#main-content').html(content);

    // Get the filter elements
  const monthFilter = document.getElementById('monthPlanFilter');
  const yearFilter = document.getElementById('yearPlanFilter');

  // Only set the default values if the filters are not already set (i.e., not modified by the user)
  
  if (!monthFilter.value) {
    monthFilter.value = currentMonth; // Set default to current month if not selected
  }
  if (!yearFilter.value) {
    yearFilter.value = currentYear.toString(); // Set default to current year if not selected
  }
  

  // Initial data load
  goToPlanPage(1); // Load the first page by default
}



function getAllIncomeByMonthAndYear(month, year, callback){
  // Fetch paginated data

google.script.run.withSuccessHandler(function(response) {
    if (response && response.length > 0) {
      const totalIncome = calculateTotalIncome(response); // Calculate total income
      callback(totalIncome); // Return total income via callback
    } else {
      callback(0); // Return 0 if no income data is found
    }
  })
  .withFailureHandler(function(error) {

    callback(0); // Return 0 in case of an error
  })
  .getIncome(month, year);
}


function getAllPlansByMonthAndYear(month, year, callback){
  // Fetch paginated data

google.script.run.withSuccessHandler(function(response) {
    if (response && response.length > 0) {
      const totalPlanned = calculateTotalPlanned(response); // Calculate total income
      callback(totalPlanned); // Return total income via callback
    } else {
      callback(0); // Return 0 if no income data is found
    }
  })
  .withFailureHandler(function(error) {

    callback(0); // Return 0 in case of an error
  })
  .getPlans(month, year);
}

function goToIncomePage(page){
   if (page < 1 || page > totalPages) return;

  const month = document.getElementById('monthIncomeFilter').value || 'All';
  const year = document.getElementById('yearIncomeFilter').value || 'All';
  const searchTerm = document.getElementById('incomeSearch').value || '';

  showSpinner();

  const startIndex = (page - 1) * itemsPerPage;




  // Fetch paginated data
  google.script.run.withSuccessHandler(function(response) {
    hideSpinner();

    if (response && response.data && response.data.length > 0) {
      incomes = response.data; // Update plans with paginated data
      totalPages = Math.ceil(response.totalRecords / itemsPerPage);
      renderIncome();
     
      
      updatePaginationControls(page, totalPages); // Update pagination controls
    } else {
      // If no plans are found, show a message and clear the list
      incomes = [];
      document.getElementById('incomeList').innerHTML = `
        <li class="list-group-item text-muted">No Income found for the selected filters.</li>
      `;
      updatePaginationControls(0, 0); // Hide pagination controls
    }
  })
   .withFailureHandler(function(error) {
      hideSpinner(); // Ensure spinner is hidden on failure
      $('#incomeList').html('<li class="list-group-item text-danger">Error loading income data. Please try again later.</li>');
    }).getFilteredIncomesWithCount(month, year, searchTerm, startIndex, itemsPerPage);

  
}

function goToBadgePage(page, onlyRender = false){
 
   if (page < 1 || page > totalPages) return;
  const searchTerm = document.getElementById('badgeSearch') ? document.getElementById('badgeSearch').value : '';
   showSpinner();

  const startIndex = (page - 1) * itemsPerPage;

  // Fetch paginated data
  google.script.run.withSuccessHandler(function(response) {
    hideSpinner();
    if (response && response.data && response.data.length > 0) {
     
      badges = response.data; // Update plans with paginated data
      newlyEarnedBadges = response.newEarnedBadges;
      totalPages = Math.ceil(response.totalRecords / itemsPerPage);
      renderBadges(badges);
      updatePaginationControls(page, totalPages); // Update pagination controls

     
       //  If newly earned badges, alert the user
        if (newlyEarnedBadges && newlyEarnedBadges.length > 0) {
          alertNewBadges(newlyEarnedBadges);
        }
    } else {
      // If no badges are found, show a message and clear the list
      badges = [];
      document.getElementById('badges').innerHTML = `
        <li class="list-group-item text-muted">No badges found for the selected filters.</li>
      `;
      updatePaginationControls(0, 0); // Hide pagination controls
    }
  })
   .withFailureHandler(function(error) {
      hideSpinner(); // Ensure spinner is hidden on failure
      $('#badges').html('<li class="list-group-item text-danger">Error loading badge data. Please try again later.</li>');
    }).getFilteredBadgesWithCount(searchTerm, startIndex, itemsPerPage, onlyRender);

}

function goToCategoryPage(page){
  if (page < 1 || page > totalPages) return;
  const searchTerm = document.getElementById('categorySearch').value || '';
   showSpinner();
  const startIndex = (page - 1) * itemsPerPage;

  // Fetch paginated data
  google.script.run.withSuccessHandler(function(response) {
    hideSpinner();

    if (response && response.data && response.data.length > 0) {
      categories = response.data; // Update plans with paginated data
      totalPages = Math.ceil(response.totalRecords / itemsPerPage);
      renderCategories();
      updatePaginationControls(page, totalPages); // Update pagination controls
    } else {
      // If no plans are found, show a message and clear the list
      categories = [];
      document.getElementById('categoryList').innerHTML = `
        <li class="list-group-item text-muted">No categories found for the selected filters.</li>
      `;
      updatePaginationControls(0, 0); // Hide pagination controls
    }
  })
   .withFailureHandler(function(error) {
      hideSpinner(); // Ensure spinner is hidden on failure

      $('#planList').html('<li class="list-group-item text-danger">Error loading category data. Please try again later.</li>');
    }).getFilteredCategoriesWithCount('', '', searchTerm, startIndex, itemsPerPage);
}


function goToPlanPage(page) {
  if (page < 1 || page > totalPages) return;

  const month = document.getElementById('monthPlanFilter').value || 'All';
  const year = parseInt(document.getElementById('yearPlanFilter').value) || 'All';
  const searchTerm = document.getElementById('planSearch').value || '';

  showSpinner();

  const startIndex = (page - 1) * itemsPerPage;

  // Fetch paginated data
  google.script.run.withSuccessHandler(function(response) {
    hideSpinner();

    if (response && response.data && response.data.length > 0) {
      plans = response.data; // Update plans with paginated data
      totalPages = Math.ceil(response.totalRecords / itemsPerPage);
      renderPlan();
      updateRemainingIncomeAmountDisplay();
  
      
      updatePaginationControls(page, totalPages); // Update pagination controls
    } else {
      // If no plans are found, show a message and clear the list
      plans = [];
      document.getElementById('planList').innerHTML = `
        <li class="list-group-item text-muted">No plans found for the selected filters.</li>
      `;
      updateRemainingIncomeAmountDisplay();
      updatePaginationControls(0, 0); // Hide pagination controls
    }
  })
   .withFailureHandler(function(error) {
      hideSpinner(); // Ensure spinner is hidden on failure
      $('#planList').html('<li class="list-group-item text-danger">Error loading plan data. Please try again later.</li>');
    }).getFilteredPlansWithCount(month, year, searchTerm, startIndex, itemsPerPage);
}

function goToSpecificPlanPage() {
  const page = parseInt($('#currentPageInput').val());
  goToPlanPage(page);
}

function goToSpecificIncomePage() {
  const page = parseInt($('#currentPageInput').val());
  goToIncomePage(page);
}


function goToSpecificCategoryPage() {
  const page = parseInt($('#currentPageInput').val());
  goToCategoryPage(page);
}

function goToSpecificBadgePage(){
  const page = parseInt($('#currentPageInput').val());
  goToBadgePage(page);
}

function updatePaginationControls(page, totalPages) {
  currentPage = page;

  // Update page display
  $('#currentPageInput').val(page);
  $('#totalPages').text(totalPages);

  // Enable/disable buttons
  $('#prevPage').prop('disabled', page <= 1);
  $('#nextPage').prop('disabled', page >= totalPages);
}

function alertNewBadges(badgeNames) {
  let message = ` Congratulations! You earned ${badgeNames.length > 1 ? 'new badges' : 'a new badge'}:\n\n`;
  badgeNames.forEach(badge => {
    message += ` ${badge[2]}` + '\n' + `${badge[3]}`;
  });
  alert(message);
}





  </script>
</body>

</html>